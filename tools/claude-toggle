#!/bin/bash
# claude-toggle - Switch API provider for Dream Team agents
#
# Lets you route some agents through a cheaper proxy while keeping others on
# direct Anthropic API. Toggle sets both the current shell and the tmux session
# environment so new panes (agent spawns) inherit the right mode.
#
# Setup:
#   1. Copy this script to ~/.local/bin/ (or anywhere on your PATH)
#   2. chmod +x claude-toggle
#   3. Add to your .zshrc:
#        export PROVIDER_URL="https://your-proxy/api/anthropic"
#        export PROVIDER_TOKEN="your-token-here"
#        ct() { eval "$(claude-toggle "$@")"; }
#
# Usage: ct proxy | ct direct | ct status
#
# When toggled to proxy, sets ANTHROPIC_BASE_URL and ANTHROPIC_AUTH_TOKEN
# from your PROVIDER_URL and PROVIDER_TOKEN values.
# When toggled to direct, unsets them so Claude uses the Anthropic API.

case "${1:-status}" in
  proxy|p)
    if [ -z "$PROVIDER_URL" ]; then
      printf '\033[0;31mError: Set PROVIDER_URL and PROVIDER_TOKEN env vars.\033[0m\n' >&2
      exit 1
    fi
    [ -n "$TMUX" ] && tmux set-environment ANTHROPIC_BASE_URL "$PROVIDER_URL" 2>/dev/null \
                    && tmux set-environment ANTHROPIC_AUTH_TOKEN "$PROVIDER_TOKEN" 2>/dev/null
    echo "export ANTHROPIC_BASE_URL=\"$PROVIDER_URL\""
    echo "export ANTHROPIC_AUTH_TOKEN=\"$PROVIDER_TOKEN\""
    printf '\033[0;33m✦ proxy mode\033[0m (%s)\n' "$PROVIDER_URL" >&2
    ;;
  direct|d)
    [ -n "$TMUX" ] && tmux set-environment -r ANTHROPIC_BASE_URL 2>/dev/null \
                    && tmux set-environment -r ANTHROPIC_AUTH_TOKEN 2>/dev/null
    echo "unset ANTHROPIC_BASE_URL ANTHROPIC_AUTH_TOKEN"
    printf '\033[0;36m✦ direct mode (Anthropic API)\033[0m\n' >&2
    ;;
  status|s)
    if [ -n "$ANTHROPIC_BASE_URL" ]; then
      printf '\033[0;33m✦ proxy mode\033[0m (%s)\n' "$ANTHROPIC_BASE_URL" >&2
    else
      printf '\033[0;36m✦ direct mode (Anthropic API)\033[0m\n' >&2
    fi
    ;;
  *)
    printf 'Usage: ct [proxy|direct|status]\n' >&2
    ;;
esac
